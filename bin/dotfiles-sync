#!/usr/bin/env zsh
# Sync dotfiles and Brewfile to repository
#
# This script automatically syncs files based on the repository structure:
# - Files in dotfiles/ are synced from ~/
# - Directories in apps/ with Preferences/ subdirs sync plists from ~/Library/Preferences/
# - Directories in apps/ without Preferences/ sync from ~/.config/
#
# To add a new file to sync: just copy it to the appropriate location once,
# and this script will keep it in sync from then on.

echo "ðŸ”„ Syncing dotfiles repository..."

# Navigate to repo root (handle symlinks correctly)
if [[ -L "$0" ]]; then
    # Follow symlink to get actual script location
    SCRIPT_PATH="$(readlink "$0")"
else
    SCRIPT_PATH="$0"
fi
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
cd "$REPO_ROOT"

# Update Brewfile
echo "\nðŸ“¦ Updating Brewfile..."
brew bundle dump --file=brew/Brewfile --force

# ============================================================================
# Sync dotfiles from home directory
# ============================================================================

echo "\nðŸ“„ Syncing dotfiles..."
synced=0
skipped=0

if [[ -d "dotfiles" ]]; then
    for dest_file in dotfiles/.*; do
        # Skip . and ..
        [[ "$dest_file" == "dotfiles/." || "$dest_file" == "dotfiles/.." ]] && continue

        # Get filename (e.g., .zshrc)
        filename="${dest_file#dotfiles/}"
        src_file="$HOME/$filename"

        if [[ -e "$src_file" ]]; then
            cp "$src_file" "$dest_file" 2>/dev/null && ((synced++)) || ((skipped++))
        else
            ((skipped++))
        fi
    done
fi

echo "   Synced: $synced | Skipped: $skipped"

# ============================================================================
# Sync application configs from apps/
# ============================================================================

echo "\nâš™ï¸  Syncing application configs..."
synced=0
skipped=0

if [[ -d "apps" ]]; then
    for app_dir in apps/*/; do
        [[ ! -d "$app_dir" ]] && continue

        app_name="${app_dir#apps/}"
        app_name="${app_name%/}"

        # Check for Preferences subdirectory (for plists)
        if [[ -d "$app_dir/Preferences" ]]; then
            # Sync .plist files from ~/Library/Preferences/
            for dest_file in "$app_dir/Preferences/"*.plist; do
                [[ ! -f "$dest_file" ]] && continue

                filename="${dest_file##*/}"
                src_file="$HOME/Library/Preferences/$filename"

                if [[ -f "$src_file" ]]; then
                    mkdir -p "$(dirname "$dest_file")"
                    cp "$src_file" "$dest_file" 2>/dev/null && ((synced++)) || ((skipped++))
                else
                    ((skipped++))
                fi
            done
        fi

        # Check for AppSupport subdirectory (for Application Support files)
        if [[ -d "$app_dir/AppSupport" ]]; then
            # Sync from ~/Library/Application Support/
            src_dir="$HOME/Library/Application Support/$app_name"

            if [[ -d "$src_dir" ]]; then
                mkdir -p "$app_dir/AppSupport"
                cp -r "$src_dir/." "$app_dir/AppSupport/" 2>/dev/null && ((synced++)) || ((skipped++))
            else
                ((skipped++))
            fi
        fi

        # If no special subdirs, sync from ~/.config/
        if [[ ! -d "$app_dir/Preferences" && ! -d "$app_dir/AppSupport" ]]; then
            src_dir="$HOME/.config/$app_name"

            if [[ -d "$src_dir" ]]; then
                mkdir -p "$app_dir"
                cp -r "$src_dir/." "$app_dir/" 2>/dev/null && ((synced++)) || ((skipped++))
            else
                ((skipped++))
            fi
        fi
    done
fi

echo "   Synced: $synced | Skipped: $skipped"

# ============================================================================
# Auto-fix common issues (trailing whitespace, newlines)
# ============================================================================

echo "\nðŸ”§ Auto-fixing formatting issues..."

# Fix formatting issues using Python (mimics pre-commit hooks exactly)
python3 << 'PYTHON_EOF'
import os
import re
from pathlib import Path

def fix_file(filepath):
    """Fix trailing whitespace and ensure exactly one newline at EOF"""
    try:
        with open(filepath, 'rb') as f:
            original = f.read()

        # Decode to text
        try:
            content = original.decode('utf-8')
        except UnicodeDecodeError:
            return  # Skip binary files

        # Fix trailing whitespace on each line
        lines = content.splitlines(keepends=True)
        fixed_lines = [line.rstrip() + ('\n' if line.endswith(('\n', '\r\n', '\r')) else '')
                      for line in lines]

        # Join and ensure exactly one newline at end
        fixed = ''.join(fixed_lines).rstrip() + '\n'

        # Write back if changed
        if fixed.encode('utf-8') != original:
            with open(filepath, 'wb') as f:
                f.write(fixed.encode('utf-8'))
    except Exception:
        pass  # Skip files that can't be processed

# Find and fix all text files
for pattern in ['dotfiles/.*', 'apps/**/*.toml', 'apps/**/*.json', 'apps/**/*.yml', 'apps/**/*.yaml', 'apps/**/*.conf']:
    for filepath in Path('.').glob(pattern):
        if filepath.is_file() and filepath.name != '.DS_Store' and not filepath.name.endswith('.plist'):
            fix_file(filepath)
PYTHON_EOF

# ============================================================================
# Ensure symlinks exist
# ============================================================================

if [[ ! -L ~/.local/bin/dotfiles-sync ]]; then
    echo "\nðŸ”— Creating command symlinks..."
    mkdir -p ~/.local/bin
    ln -sf "$REPO_ROOT/bin/dotfiles-sync" ~/.local/bin/dotfiles-sync
    ln -sf "$REPO_ROOT/bin/dotfiles-restore" ~/.local/bin/dotfiles-restore
    ln -sf "$REPO_ROOT/bin/dotfiles-setup" ~/.local/bin/dotfiles-setup
    ln -sf "$REPO_ROOT/bin/dotfiles-add-app" ~/.local/bin/dotfiles-add-app
fi

# ============================================================================
# Summary
# ============================================================================

echo ""
if [[ -n $(git status --porcelain) ]]; then
    echo "âœ¨ Changes detected:"
    git status --short
    echo "\nðŸ’¡ Next steps:"
    echo "   - Review: git diff"
    echo "   - Commit: git add . && git commit -m \"Update dotfiles\" && git push"
else
    echo "âœ… Everything is already in sync!"
fi
