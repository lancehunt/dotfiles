#!/usr/bin/env zsh
# Initial setup script for dotfiles repository
# âš ï¸  FOR FRESH INSTALLS ONLY - Will overwrite existing configs!
# âš ï¸  If you already have configs, use 'dotfiles-restore' instead for safety checks.

echo "ğŸš€ Setting up development environment..."
echo ""
echo "âš ï¸  WARNING: This script will OVERWRITE existing configuration files!"
echo "   - Use this for fresh installations only"
echo "   - For existing setups, use 'dotfiles-restore' which has safety checks"
echo ""
read "confirm?Continue with fresh install? (y/N): "

if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
    echo "Aborted."
    exit 0
fi

# Navigate to repo root (handle symlinks correctly)
if [[ -L "$0" ]]; then
    # Follow symlink to get actual script location
    SCRIPT_PATH="$(readlink "$0")"
else
    SCRIPT_PATH="$0"
fi
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
cd "$REPO_ROOT"

# Create symlinks in ~/.local/bin for easy access
echo "\nğŸ”— Creating command symlinks..."
mkdir -p ~/.local/bin
ln -sf "$REPO_ROOT/bin/dotfiles-sync" ~/.local/bin/dotfiles-sync
ln -sf "$REPO_ROOT/bin/dotfiles-restore" ~/.local/bin/dotfiles-restore
ln -sf "$REPO_ROOT/bin/dotfiles-setup" ~/.local/bin/dotfiles-setup
ln -sf "$REPO_ROOT/bin/dotfiles-add-app" ~/.local/bin/dotfiles-add-app
echo "   Commands available: dotfiles-sync, dotfiles-restore, dotfiles-setup, dotfiles-add-app"

# Install Homebrew
echo "\nğŸ“¦ Installing Homebrew..."
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
brew update -y

# Install oh-my-zsh
echo "\nğŸš Installing oh-my-zsh..."
sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"

# Install packages from Brewfile
echo "\nğŸ“¥ Installing packages from Brewfile..."
brew bundle --file=brew/Brewfile

# Copy dotfiles to home directory
echo "\nğŸ“„ Installing dotfiles..."
cp dotfiles/.* ~/ 2>/dev/null || true

# Install application configs
echo "\nâš™ï¸  Installing application configs..."
if [[ -d "apps" ]]; then
    for app_dir in apps/*/; do
        [[ ! -d "$app_dir" ]] && continue

        app_name="${app_dir#apps/}"
        app_name="${app_name%/}"

        # Install Preferences
        if [[ -d "$app_dir/Preferences" ]]; then
            echo "   - $app_name preferences"
            cp -r "$app_dir/Preferences/." ~/Library/Preferences/ 2>/dev/null || true
        fi

        # Install Application Support
        if [[ -d "$app_dir/AppSupport" ]]; then
            echo "   - $app_name application support"
            mkdir -p "$HOME/Library/Application Support/$app_name"
            cp -r "$app_dir/AppSupport/." "$HOME/Library/Application Support/$app_name/" 2>/dev/null || true
        fi

        # Install from .config if no special subdirs
        if [[ ! -d "$app_dir/Preferences" && ! -d "$app_dir/AppSupport" ]]; then
            echo "   - $app_name config"
            mkdir -p ~/.config
            cp -r "$app_dir" ~/.config/ 2>/dev/null || true
        fi
    done
fi

# Install Vim plugin manager
echo "\nğŸ”Œ Installing Vundle for Vim..."
git clone https://github.com/VundleVim/Vundle.vim.git ~/.vim/bundle/Vundle.vim 2>/dev/null || true

# Setup git-secrets
echo "\nğŸ” Configuring git-secrets..."
git secrets --register-aws --global

echo "\nâœ… Setup complete! Restart your terminal to apply changes."
